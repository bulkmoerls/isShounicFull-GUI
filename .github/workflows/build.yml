name: Build Release
on: [push, pull_request]

jobs:
  build:
    name: Build for ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: amd64
            goos: linux
          - os: windows-latest
            arch: amd64
            goos: windows
          - os: windows-latest
            arch: "386"
            goos: windows

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      # --- LINUX DEPENDENCIES ---
      - name: Install Linux Dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libglib2.0-dev libc6-dev gettext

      # --- WINDOWS DEPENDENCIES ---
      - name: Install Windows Dependencies (MSYS2)
        if: matrix.os == 'windows-latest'
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.arch == 'amd64' && 'MINGW64' || 'MINGW32' }}
          install: >-
            mingw-w64-${{ matrix.arch == 'amd64' && 'x86_64' || 'i686' }}-gtk3
            mingw-w64-${{ matrix.arch == 'amd64' && 'x86_64' || 'i686' }}-toolchain

      # --- BUILD STEP ---
      - name: Build Binary
        shell: bash
        run: |
          # 2. Configure Environment and Build
          # We use -tags "gtk_3_18" to avoid the 'undefined: callback' error in gotk3 v0.6.4
          export CGO_CFLAGS="-I$(pwd)/fake_include"
          
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            # Windows: Ensure MSYS2 tools are in path
            export PATH=$MSYS2_PATH_TYPE:$PATH
            go build -v -tags "gtk_3_18" -o isShounicFull-${{ matrix.goos }}-${{ matrix.arch }}.exe .
          else
            # Linux: Standard build
            go build -v -tags "gtk_3_18" -o isShounicFull-${{ matrix.goos }}-${{ matrix.arch }} .
          fi

      # --- UPLOAD ---
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: isShounicFull-${{ matrix.goos }}-${{ matrix.arch }}
          path: isShounicFull-*
