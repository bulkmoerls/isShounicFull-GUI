name: Build Release
on: [push, pull_request]

jobs:
  build:
    name: Build for ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: amd64
            goos: linux
          - os: windows-latest
            arch: amd64
            goos: windows
          - os: windows-latest
            arch: "386"
            goos: windows

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21' # Or your preferred version

      # --- LINUX SPECIFIC SETUP ---
      - name: Install Linux Dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libglib2.0-dev libc6-dev gettext

      # --- WINDOWS SPECIFIC SETUP ---
      - name: Install Windows Dependencies (MSYS2)
        if: matrix.os == 'windows-latest'
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.arch == 'amd64' && 'MINGW64' || 'MINGW32' }}
          install: >-
            mingw-w64-${{ matrix.arch == 'amd64' && 'x86_64' || 'i686' }}-gtk3
            mingw-w64-${{ matrix.arch == 'amd64' && 'x86_64' || 'i686' }}-toolchain

      - name: Build
        shell: bash
        run: |
          # Create fake include for Linux just in case, though apt install usually fixes it
          mkdir -p fake_include
          touch fake_include/libintl.h
          
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            # Use the MSYS2 compiler for Windows
            export PATH=$MSYS2_PATH_TYPE:$PATH
            go build -v -o isShounicFull-${{ matrix.goos }}-${{ matrix.arch }}.exe .
          else
            # Standard Linux build
            CGO_CFLAGS="-I$(pwd)/fake_include" go build -v -o isShounicFull-${{ matrix.goos }}-${{ matrix.arch }} .
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: isShounicFull-${{ matrix.goos }}-${{ matrix.arch }}
          path: isShounicFull-*
